================================================================================
GUIA COMPLETA DE PRUEBAS - GESTOR WS
================================================================================

Este documento contiene todos los pasos necesarios para probar el sistema
Gestor WS desde cero.

================================================================================
1. CONFIGURACION INICIAL
================================================================================

1.1. Verificar que el ERP Mock esté corriendo:
     cd ..\erp_mock
     docker-compose up -d

1.2. Verificar que el ERP Mock responda:
     Invoke-RestMethod -Uri "http://localhost:8001/health" -Method Get

1.3. Volver al directorio del Gestor WS:
     cd ..\gestor_ws


================================================================================
2. COMANDOS DOCKER COMPOSE
================================================================================

2.1. LEVANTAR LOS SERVICIOS:
     docker-compose up -d

2.2. VER LOGS EN TIEMPO REAL:
     docker-compose logs -f api
     docker-compose logs -f postgres

2.3. VER LOGS RECIENTES (últimas 50 líneas):
     docker-compose logs --tail 50 api

2.4. REINICIAR UN SERVICIO:
     docker-compose restart api
     docker-compose restart postgres

2.5. DETENER LOS SERVICIOS (sin eliminar):
     docker-compose stop

2.6. BAJAR LOS SERVICIOS (detener y eliminar contenedores):
     docker-compose down

2.7. BAJAR Y ELIMINAR VOLUMENES (borra datos de BD):
     docker-compose down -v

2.8. VER ESTADO DE LOS SERVICIOS:
     docker-compose ps

2.9. ACCEDER AL CONTENEDOR:
     docker-compose exec api bash


================================================================================
3. ACTUALIZAR DEPENDENCIAS (requirements.txt)
================================================================================

Si modificas requirements.txt, necesitas reconstruir la imagen:

3.1. RECONSTRUIR LA IMAGEN SIN CACHE:
     docker-compose build --no-cache api

3.2. LEVANTAR CON LA NUEVA IMAGEN:
     docker-compose up -d

3.3. VERIFICAR QUE FUNCIONA:
     docker-compose logs --tail 30 api

Ejemplo de cuando se actualizaron las librerías de LangChain:
   - Cambiamos langchain-core==0.1.10 a langchain-core>=0.2.0
   - Cambiamos langchain-google-genai==0.0.6 a langchain-google-genai>=1.0.0
   - Ejecutamos: docker-compose build --no-cache api
   - Luego: docker-compose up -d


================================================================================
4. CONFIGURACION LLM (.env)
================================================================================

4.1. EDITAR ARCHIVO .env:
     Copiar env.example a .env si no existe:
     Copy-Item env.example .env -Force

     Editar .env con tus credenciales:
     notepad .env

4.2. VARIABLES IMPORTANTES:
     
     # Para usar OpenAI:
     LLM_PROVIDER=openai
     LLM_MODEL=gpt-4o
     OPENAI_API_KEY=tu_key_aqui

     # Para usar Google Gemini:
     LLM_PROVIDER=google
     LLM_MODEL=gemini-2.0-flash-exp
     GOOGLE_API_KEY=tu_key_aqui

4.3. APLICAR CAMBIOS:
     Después de editar .env, reiniciar completamente:
     docker-compose down
     docker-compose up -d


================================================================================
5. PROBAR CONEXION LLM
================================================================================

5.1. INSTALAR DEPENDENCIAS LOCALMENTE (si no están):
     ..\xx\Scripts\Activate.ps1  # Activar entorno virtual
     pip install python-dotenv langchain-openai langchain-google-genai langchain-core

5.2. PROBAR EL PROVEEDOR CONFIGURADO:
     python test_llm_connection.py

5.3. PROBAR SOLO OPENAI:
     python test_llm_connection.py --openai

5.4. PROBAR SOLO GOOGLE:
     python test_llm_connection.py --google

5.5. PROBAR AMBOS:
     python test_llm_connection.py --all

5.6. VER MODELOS DISPONIBLES:
     python test_llm_connection.py --list-models


================================================================================
6. VERIFICAR QUE EL SISTEMA ESTA CORRIENDO
================================================================================

6.1. HEALTH CHECK GENERAL:
     Invoke-RestMethod -Uri "http://localhost:8000/health" -Method Get | ConvertTo-Json

6.2. HEALTH CHECK LLM:
     Invoke-RestMethod -Uri "http://localhost:8000/health/llm" -Method Get | ConvertTo-Json

6.3. HEALTH CHECK ERP:
     Invoke-RestMethod -Uri "http://localhost:8000/health/erp" -Method Get | ConvertTo-Json

6.4. VER DOCUMENTACION API:
     Abrir en navegador: http://localhost:8000/docs


================================================================================
7. PROBAR WEBHOOKS WHATSAPP (RECIBIR MENSAJES)
================================================================================

7.1. MENSAJE SIMPLE (SALUDO):
     $body = @{
         from_number = "+5491112345005"
         text = "Hola"
     } | ConvertTo-Json
     
     Invoke-RestMethod -Uri "http://localhost:8000/webhook/whatsapp/test" `
                       -Method Post `
                       -ContentType "application/json" `
                       -Body $body | ConvertTo-Json -Depth 10

7.2. CONSULTA DE DEUDA:
     $body = @{
         from_number = "+5491112345005"
         text = "Cuanto debo?"
     } | ConvertTo-Json
     
     Invoke-RestMethod -Uri "http://localhost:8000/webhook/whatsapp/test" `
                       -Method Post `
                       -ContentType "application/json" `
                       -Body $body | ConvertTo-Json -Depth 10

7.3. SOLICITUD DE LINK DE PAGO:
     $body = @{
         from_number = "+5491112345005"
         text = "Necesito el link de pago"
     } | ConvertTo-Json
     
     Invoke-RestMethod -Uri "http://localhost:8000/webhook/whatsapp/test" `
                       -Method Post `
                       -ContentType "application/json" `
                       -Body $body | ConvertTo-Json -Depth 10

7.4. ESCALAMIENTO (RECLAMO):
     $body = @{
         from_number = "+5491112345005"
         text = "Tengo un reclamo"
     } | ConvertTo-Json
     
     Invoke-RestMethod -Uri "http://localhost:8000/webhook/whatsapp/test" `
                       -Method Post `
                       -ContentType "application/json" `
                       -Body $body | ConvertTo-Json -Depth 10

7.5. PLAN DE PAGOS:
     $body = @{
         from_number = "+5491112345005"
         text = "Necesito un plan de pagos"
     } | ConvertTo-Json
     
     Invoke-RestMethod -Uri "http://localhost:8000/webhook/whatsapp/test" `
                       -Method Post `
                       -ContentType "application/json" `
                       -Body $body | ConvertTo-Json -Depth 10


================================================================================
8. PROBAR WEBHOOK REAL (CON ENVIO DE RESPUESTA)
================================================================================

NOTA: El endpoint /webhook/whatsapp/test solo procesa, no envía respuesta.
      El endpoint /webhook/whatsapp SÍ envía respuesta (simulada).

8.1. MENSAJE REAL (con envío simulado):
     $body = @{
         from_number = "+5491112345005"
         text = "Cuanto debo?"
     } | ConvertTo-Json
     
     Invoke-RestMethod -Uri "http://localhost:8000/webhook/whatsapp" `
                       -Method Post `
                       -ContentType "application/json" `
                       -Body $body | ConvertTo-Json -Depth 10

     Ver respuesta en logs:
     docker-compose logs --tail 20 api


================================================================================
9. PROBAR WEBHOOKS DEL ERP (RECIBIR EVENTOS)
================================================================================

9.1. WEBHOOK: PAGO CONFIRMADO
     $body = @{
         tipo = "pago_confirmado"
         timestamp = (Get-Date).ToUniversalTime().ToString("o")
         datos = @{
             cuota_id = "CUO-001"
             alumno_id = "ALU-001"
             monto = 45000.00
             metodo_pago = "transferencia"
             fecha_pago = (Get-Date).ToUniversalTime().ToString("o")
         }
     } | ConvertTo-Json -Depth 5
     
     Invoke-RestMethod -Uri "http://localhost:8000/webhook/erp/pago-confirmado" `
                       -Method Post `
                       -ContentType "application/json" `
                       -Body $body | ConvertTo-Json

9.2. WEBHOOK: CUOTA GENERADA
     $body = @{
         tipo = "cuota_generada"
         timestamp = (Get-Date).ToUniversalTime().ToString("o")
         datos = @{
             cuota_id = "CUO-002"
             alumno_id = "ALU-001"
             monto = 45000.00
             fecha_vencimiento = "2024-02-15"
             link_pago = "https://pago.test.com/CUO-002"
         }
     } | ConvertTo-Json -Depth 5
     
     Invoke-RestMethod -Uri "http://localhost:8000/webhook/erp/cuota-generada" `
                       -Method Post `
                       -ContentType "application/json" `
                       -Body $body | ConvertTo-Json


================================================================================
10. PROBAR API ADMINISTRATIVA
================================================================================

10.1. LISTAR TICKETS:
      Invoke-RestMethod -Uri "http://localhost:8000/api/admin/tickets" `
                        -Method Get | ConvertTo-Json -Depth 5

10.2. VER ESTADISTICAS:
      Invoke-RestMethod -Uri "http://localhost:8000/api/admin/stats" `
                        -Method Get | ConvertTo-Json

10.3. OBTENER UN TICKET (cambiar {ticket_id} por un ID real):
      Invoke-RestMethod -Uri "http://localhost:8000/api/admin/tickets/{ticket_id}" `
                        -Method Get | ConvertTo-Json


================================================================================
11. VER LOGS Y DEPURACION
================================================================================

11.1. VER TODOS LOS LOGS DEL API:
      docker-compose logs api

11.2. SEGUIR LOGS EN TIEMPO REAL:
      docker-compose logs -f api

11.3. FILTRAR LOGS POR ERRORES:
      docker-compose logs api 2>&1 | Select-String -Pattern "error|Error|ERROR|exception"

11.4. VER LOGS DE LOS ULTIMOS 5 MINUTOS:
      docker-compose logs --since 5m api

11.5. VER LOGS ENTRE FECHAS:
      docker-compose logs --since "2024-01-10T18:00:00" --until "2024-01-10T19:00:00" api


================================================================================
12. RESOLVER PROBLEMAS COMUNES
================================================================================

12.1. PROBLEMA: "Port already in use"
      SOLUCION: 
      - Ver qué proceso usa el puerto 8000: netstat -ano | findstr :8000
      - Detener el servicio que lo usa, o cambiar el puerto en docker-compose.yml

12.2. PROBLEMA: "Cannot connect to ERP"
      SOLUCION:
      - Verificar que ERP Mock esté corriendo: docker-compose ps (en erp_mock)
      - Verificar URL en .env: MOCK_ERP_URL=http://host.docker.internal:8001
      - Desde Docker, usar host.docker.internal para acceder al host

12.3. PROBLEMA: "LLM authentication error"
      SOLUCION:
      - Verificar API keys en .env
      - Probar con test_llm_connection.py
      - Verificar que el modelo sea válido (gpt-4o para OpenAI, gemini-2.0-flash-exp para Google)

12.4. PROBLEMA: "Database connection error"
      SOLUCION:
      - Verificar que PostgreSQL esté corriendo: docker-compose ps postgres
      - Verificar DATABASE_URL en .env
      - Reiniciar: docker-compose restart postgres

12.5. PROBLEMA: Dependencias desactualizadas después de cambiar requirements.txt
      SOLUCION:
      - Reconstruir imagen: docker-compose build --no-cache api
      - Levantar: docker-compose up -d
      - Verificar logs: docker-compose logs --tail 30 api


================================================================================
13. SCRIPT DE PRUEBA AUTOMATIZADO
================================================================================

13.1. USAR EL SCRIPT test_whatsapp.py:
      python scripts\test_whatsapp.py "+5491112345005" "Cuanto debo?"

13.2. MODO INTERACTIVO:
      python scripts\test_whatsapp.py -i

13.3. CONFIGURAR URL DEL API (si no es localhost:8000):
      Editar scripts\test_whatsapp.py y cambiar API_URL


================================================================================
14. FLUJO COMPLETO DE PRUEBA MANUAL
================================================================================

PASO 1: Verificar que todo esté corriendo
   docker-compose ps
   Invoke-RestMethod -Uri "http://localhost:8000/health" -Method Get

PASO 2: Probar conexión LLM
   python test_llm_connection.py --all

PASO 3: Enviar mensaje de saludo
   $body = @{ from_number = "+5491112345005"; text = "Hola" } | ConvertTo-Json
   Invoke-RestMethod -Uri "http://localhost:8000/webhook/whatsapp/test" `
                     -Method Post -ContentType "application/json" -Body $body

PASO 4: Enviar consulta de deuda
   $body = @{ from_number = "+5491112345005"; text = "Cuanto debo?" } | ConvertTo-Json
   Invoke-RestMethod -Uri "http://localhost:8000/webhook/whatsapp/test" `
                     -Method Post -ContentType "application/json" -Body $body

PASO 5: Ver logs en tiempo real
   docker-compose logs -f api

PASO 6: Verificar interacciones en BD (opcional)
   docker-compose exec api python -c "from app.database import async_session_maker; from app.models.interacciones import Interaccion; from sqlalchemy import select; import asyncio; asyncio.run(async_session_maker()).execute(select(Interaccion)).all()"


================================================================================
15. COMANDOS UTILES ADICIONALES
================================================================================

15.1. LIMPIAR TODO Y EMPEZAR DE NUEVO:
      docker-compose down -v
      docker-compose build --no-cache
      docker-compose up -d

15.2. VER ESPACIO USADO POR DOCKER:
      docker system df

15.3. LIMPIAR IMAGENES NO USADAS:
      docker image prune -a

15.4. VER VARIABLES DE ENTORNO DEL CONTENEDOR:
      docker-compose exec api env | Select-String "LLM|ERP|DATABASE"

15.5. EJECUTAR COMANDO DENTRO DEL CONTENEDOR:
      docker-compose exec api python -c "from app.config import settings; print(settings.LLM_PROVIDER)"


================================================================================
FIN DE LA GUIA
================================================================================

Para más información, consultar:
- README.md: Documentación general
- http://localhost:8000/docs: Documentación interactiva de la API
- Logs: docker-compose logs -f api

