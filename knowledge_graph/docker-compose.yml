services:
  # Neo4j Database
  neo4j:
    image: neo4j:5-community
    container_name: knowledge_graph_neo4j
    ports:
      - "7474:7474"  # Browser
      - "7687:7687"  # Bolt
    environment:
      NEO4J_AUTH: neo4j/password123
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_apoc_export_file_enabled: "true"
      NEO4J_apoc_import_file_enabled: "true"
      NEO4J_apoc_import_file_use__neo4j__config: "true"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - kg_network
    healthcheck:
      test: ["CMD-SHELL", "wget --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Celery
  redis:
    image: redis:7-alpine
    container_name: knowledge_graph_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - kg_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API de Knowledge Graph
  api:
    build: .
    container_name: knowledge_graph_api
    ports:
      - "8002:8002"
    environment:
      # PostgreSQL (Gestor WS)
      DATABASE_URL: postgresql+asyncpg://gestor_user:gestor_pass@host.docker.internal:5432/gestor_ws
      
      # Neo4j
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: password123
      
      # ERP Mock
      MOCK_ERP_URL: http://host.docker.internal:8001
      
      # Gestor WS
      GESTOR_WS_URL: http://host.docker.internal:8000
      
      # LLM Configuration
      LLM_PROVIDER: ${LLM_PROVIDER:-google}
      LLM_MODEL: ${LLM_MODEL:-gemini-2.0-flash-exp}
      LLM_TEMPERATURE: ${LLM_TEMPERATURE:-0.7}
      LLM_MAX_TOKENS: ${LLM_MAX_TOKENS:-4000}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      
      # Celery
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      
      # API
      API_PORT: 8002
      LOG_LEVEL: INFO
    depends_on:
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - kg_network
    volumes:
      - ./app:/app/app:ro

  # Celery Worker
  celery_worker:
    build: .
    container_name: knowledge_graph_celery_worker
    command: celery -A app.etl.scheduler worker --loglevel=info
    environment:
      DATABASE_URL: postgresql+asyncpg://gestor_user:gestor_pass@host.docker.internal:5432/gestor_ws
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: password123
      MOCK_ERP_URL: http://host.docker.internal:8001
      GESTOR_WS_URL: http://host.docker.internal:8000
      LLM_PROVIDER: ${LLM_PROVIDER:-google}
      LLM_MODEL: ${LLM_MODEL:-gemini-2.0-flash-exp}
      LLM_TEMPERATURE: ${LLM_TEMPERATURE:-0.7}
      LLM_MAX_TOKENS: ${LLM_MAX_TOKENS:-4000}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
    depends_on:
      - neo4j
      - redis
    networks:
      - kg_network

  # Celery Beat (Scheduler)
  celery_beat:
    build: .
    container_name: knowledge_graph_celery_beat
    command: celery -A app.etl.scheduler beat --loglevel=info
    environment:
      DATABASE_URL: postgresql+asyncpg://gestor_user:gestor_pass@host.docker.internal:5432/gestor_ws
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: password123
      MOCK_ERP_URL: http://host.docker.internal:8001
      LLM_PROVIDER: ${LLM_PROVIDER:-google}
      LLM_MODEL: ${LLM_MODEL:-gemini-2.0-flash-exp}
      LLM_TEMPERATURE: ${LLM_TEMPERATURE:-0.7}
      LLM_MAX_TOKENS: ${LLM_MAX_TOKENS:-4000}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
    depends_on:
      - redis
    networks:
      - kg_network

networks:
  kg_network:
    name: knowledge_graph_network
    driver: bridge

volumes:
  neo4j_data:
  neo4j_logs:
  redis_data:

